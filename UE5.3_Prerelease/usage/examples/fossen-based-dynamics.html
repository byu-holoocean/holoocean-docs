<!DOCTYPE html>

<html class="writer-html5" lang="en">
<head>
<meta charset="utf-8"/><meta content="Docutils 0.18.1: http://docutils.sourceforge.net/" name="generator"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Fossen-Based Dynamics — HoloOcean 1.0.0 documentation</title>
<link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
<link href="../../_static/css/theme.css" rel="stylesheet" type="text/css"/>
<link href="../../_static/copybutton.css" rel="stylesheet" type="text/css"/>
<link href="../../_static/themes_override.css" rel="stylesheet" type="text/css"/>
<link href="../../_static/favicon.png" rel="shortcut icon"/>
<!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
<script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
<script src="../../_static/jquery.js"></script>
<script src="../../_static/underscore.js"></script>
<script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
<script src="../../_static/doctools.js"></script>
<script src="../../_static/clipboard.min.js"></script>
<script src="../../_static/copybutton.js"></script>
<script src="../../_static/js/theme.js"></script>
<link href="../../genindex.html" rel="index" title="Index"/>
<link href="../../search.html" rel="search" title="Search"/>
<link href="multi-agent.html" rel="next" title="Multi Agent Example"/>
<link href="custom-scenarios.html" rel="prev" title="Custom Scenario Configurations"/>
</head>
<body class="wy-body-for-nav">
<div class="wy-grid-for-nav">
<nav class="wy-nav-side" data-toggle="wy-nav-shift">
<div class="wy-side-scroll">
<div class="wy-side-nav-search">
<a class="icon icon-home" href="../../index.html">
            HoloOcean
          </a>
<div class="version"><a href="../../../versionList.html" style="color: inherit;">1.0.0</a></div>
<div role="search">
<form action="../../search.html" class="wy-form" id="rtd-search-form" method="get">
<input aria-label="Search docs" name="q" placeholder="Search docs" type="text"/>
<input name="check_keywords" type="hidden" value="yes"/>
<input name="area" type="hidden" value="default"/>
</form>
</div>
</div><div aria-label="Navigation menu" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
<p class="caption" role="heading"><span class="caption-text">HoloOcean Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../getting-started.html">Getting Started &amp; Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="camera.html">Visualizing RGBCamera Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="controller.html">Manually Controlling</a></li>
<li class="toctree-l2"><a class="reference internal" href="custom-dynamics.html">Manually Defining Dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="custom-scenarios.html">Custom Scenario Configurations</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Fossen-Based Dynamics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#scenario-setup">Scenario Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#manual-control-example">Manual Control Example:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#depth-and-heading-control-example">Depth and Heading Control Example:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#plotting-vehicle-state">Plotting Vehicle State:</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="multi-agent.html">Multi Agent Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="multi-coms.html">Multi-Agent Communications</a></li>
<li class="toctree-l2"><a class="reference internal" href="pd-controllers.html">PD Controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="sonar_imaging.html">Visualizing Imaging Sonar</a></li>
<li class="toctree-l2"><a class="reference internal" href="sonar_profiling.html">Visualizing Profiling Sonar</a></li>
<li class="toctree-l2"><a class="reference internal" href="sonar_sidescan.html">Visualizing Sidescan Sonar</a></li>
<li class="toctree-l2"><a class="reference internal" href="sonar_singlebeam.html">Visualizing Singlebeam Sonar</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Using HoloOcean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packages/packages.html">HoloOcean Packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../agents/agents.html">HoloOcean Agents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../develop/develop.html">Developing HoloOcean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog/changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../versionList.html">Other Versions Documentation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../holoocean/index.html">HoloOcean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../holoocean/agents.html">Agents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../holoocean/environments.html">Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../holoocean/spaces.html">Spaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../holoocean/commands.html">Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../holoocean/holooceanclient.html">HoloOcean Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../holoocean/packagemanager.html">Package Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../holoocean/sensors.html">Sensors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../holoocean/lcm.html">LCM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../holoocean/dynamics.html">Dynamics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../holoocean/ros2.html">ROS2 Wrapper</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../holoocean/shmem.html">Shared Memory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../holoocean/util.html">Util</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../holoocean/exceptions.html">Exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../holoocean/weather.html">Weather Controller</a></li>
</ul>
</div>
</div>
</nav>
<section class="wy-nav-content-wrap" data-toggle="wy-nav-shift"><nav aria-label="Mobile navigation menu" class="wy-nav-top">
<i class="fa fa-bars" data-toggle="wy-nav-top"></i>
<a href="../../index.html">HoloOcean</a>
</nav>
<div class="wy-nav-content">
<div class="rst-content">
<div aria-label="Page navigation" role="navigation">
<ul class="wy-breadcrumbs">
<li><a aria-label="Home" class="icon icon-home" href="../../index.html"></a></li>
<li class="breadcrumb-item"><a href="../getting-started.html">Getting Started &amp; Examples</a></li>
<li class="breadcrumb-item active">Fossen-Based Dynamics</li>
<li class="wy-breadcrumbs-aside">
<a href="../../_sources/usage/examples/fossen-based-dynamics.rst.txt" rel="nofollow"> View page source</a>
</li>
</ul>
<hr/>
</div>
<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div itemprop="articleBody">
<section id="fossen-based-dynamics">
<span id="fossen-dynamics"></span><h1>Fossen-Based Dynamics<a class="headerlink" href="#fossen-based-dynamics" title="Permalink to this heading"></a></h1>
<p>Dynamics for underwater and surface vehicles can be modeled using equations of motion derived from Thor Fossen’s Python Dynamics Simulation: <a class="reference external" href="https://github.com/cybergalactic/PythonVehicleSimulator">https://github.com/cybergalactic/PythonVehicleSimulator</a>. These models are explained in the book by Thor Fossen, <em>Handbook of Marine Craft Hydrodynamics and Motion Control</em>.</p>
<p>We have implemented some of these models in HoloOcean to simulate the motion of the vehicle based on control surface commands. To use these Fossen dynamics implementations with a vehicle’s “Custom Dynamics” control scheme in a simulation, we have implemented two objects that must be defined in the python script when creating a simulation:</p>
<ul class="simple">
<li><p>A vehicle controller of one of the classes described below. This implements the Fossen dynamics for that vehicle.</p></li>
<li><p>A dynamics manager of the class <cite>FossenDynamics</cite>. This handles the connection between the HoloOcean agent and the dynamics controller. It also handles coordinate frame change from NED to NWU, as HoloOcean does not currently have a defined North or West direction world coordinate frame (see <a class="reference internal" href="../units-and-coordinates.html#coordinate-system"><span class="std std-ref">Coordinate System</span></a>).</p></li>
</ul>
<p>These classes are implemented in <cite>client/src/vehicle_dynamics</cite>. The dynamics manager is located in <cite>client/src/dynamics.py</cite>.</p>
<p>Currently, we have implemented the dynamics models for one vehicle class and several child classes:</p>
<ul class="simple">
<li><dl class="simple">
<dt>Generic Torpedo Vehicle Parent class (<a class="reference internal" href="../../holoocean/dynamics.html#holoocean.vehicle_dynamics.torpedo.TAUV" title="holoocean.vehicle_dynamics.torpedo.TAUV"><code class="xref py py-class docutils literal notranslate"><span class="pre">TAUV</span></code></a>)</dt><dd><ul>
<li><p>Three Independent Fins - Torpedo-shaped vehicle (<a class="reference internal" href="../../holoocean/dynamics.html#holoocean.vehicle_dynamics.torpedo.threeFinInd" title="holoocean.vehicle_dynamics.torpedo.threeFinInd"><code class="xref py py-class docutils literal notranslate"><span class="pre">threeFinInd</span></code></a>)</p></li>
<li><p>Four Dependent Fins - Torpedo-shaped vehicle (<a class="reference internal" href="../../holoocean/dynamics.html#holoocean.vehicle_dynamics.torpedo.fourFinDep" title="holoocean.vehicle_dynamics.torpedo.fourFinDep"><code class="xref py py-class docutils literal notranslate"><span class="pre">fourFinDep</span></code></a>)</p></li>
<li><p>Four Independent Fins - Torpedo-shaped vehicle (<a class="reference internal" href="../../holoocean/dynamics.html#holoocean.vehicle_dynamics.torpedo.fourFinInd" title="holoocean.vehicle_dynamics.torpedo.fourFinInd"><code class="xref py py-class docutils literal notranslate"><span class="pre">fourFinInd</span></code></a>)</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>Note that the graphics for the vehicle model or fin configuration will not change in Unreal Engine when changing the dynamics class.</p>
<p>Default Fossen vehicle parameters are currently only tuned for the REMUS100 vehicle provided by Thor Fossen’s simulations.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Mass and other default vehicle parameters set in the engine are ignored when using the “Custom Dynamics” control scheme. The Fossen models account for these separately.</p>
</div>
<p>Below we give an example of using Fossen dynamics in HoloOcean. The full code file can be found in <cite>client/example.py</cite>.</p>
<section id="scenario-setup">
<h2>Scenario Setup<a class="headerlink" href="#scenario-setup" title="Permalink to this heading"></a></h2>
<p>The setup for the simulation is similar to other HoloOcean examples. The total simulation time can be calculated by <cite>(numSteps/ticks_per_sec)</cite>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you are running the simulation live with the Unreal Editor, make sure you change the additional launch parameters, as described in <span class="xref std std-ref">start</span>.
Be sure to add the launch parameter <cite>-TicksPerSec</cite> to match what is in the Python script for consistent timing.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">holoocean</span>
<span class="kn">import</span> <span class="nn">holoocean.vehicle_dynamics</span>

<span class="n">ticks_per_sec</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">numSteps</span> <span class="o">=</span> <span class="mi">600</span>
<span class="n">period</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">ticks_per_sec</span>

<span class="n">initial_location</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">]</span>  <span class="c1"># Translation in NWU coordinate system</span>
<span class="n">initial_rotation</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>    <span class="c1"># Roll, pitch, yaw in Euler angle order ZYX and in degrees NWU coordinate system</span>
</pre></div>
</div>
<p>For the scenario configuration, there are a few key differences to ensure dynamics work properly:</p>
<ul class="simple">
<li><p>You must include the Dynamics Sensor in the list of sensors with the configuration <cite>UseRPY: False</cite> (default is True) and <cite>UseCOM: True</cite> (default is True).</p></li>
<li><p>The extra parameters “dynamics”, “actuator”, and “autopilot” are added to the agent. Default parameters are defined in the vehicle class.</p></li>
</ul>
<p>See <code class="xref py py-func docutils literal notranslate"><span class="pre">holoocean.vehicle_dynamics.torpedo.configure_from_scenario()</span></code> for dynamics parameters definition as well as the book by Thor Fossen.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">scenario</span> <span class="o">=</span> <span class="p">{</span>
<span class="s2">"name"</span><span class="p">:</span> <span class="s2">"torpedo_dynamics"</span><span class="p">,</span>
<span class="s2">"package_name"</span><span class="p">:</span> <span class="s2">"TestWorlds"</span><span class="p">,</span>
<span class="s2">"world"</span><span class="p">:</span> <span class="s2">"ExampleLevel"</span><span class="p">,</span>
<span class="s2">"main_agent"</span><span class="p">:</span> <span class="s2">"auv0"</span><span class="p">,</span>
<span class="s2">"ticks_per_sec"</span><span class="p">:</span> <span class="n">ticks_per_sec</span><span class="p">,</span>
<span class="s2">"agents"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
        <span class="s2">"agent_name"</span><span class="p">:</span> <span class="s2">"auv0"</span><span class="p">,</span>
        <span class="s2">"agent_type"</span><span class="p">:</span> <span class="s2">"TorpedoAUV"</span><span class="p">,</span>
        <span class="s2">"sensors"</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">"sensor_type"</span><span class="p">:</span> <span class="s2">"DynamicsSensor"</span><span class="p">,</span>
                <span class="s2">"configuration"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">"UseCOM"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">"UseRPY"</span><span class="p">:</span> <span class="kc">False</span>  <span class="c1"># Use quaternion for dynamics</span>
                <span class="p">}</span>
            <span class="p">},</span>
        <span class="p">],</span>
        <span class="s2">"control_scheme"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># Control scheme 1 is how custom dynamics are applied to TAUV</span>
        <span class="s2">"location"</span><span class="p">:</span> <span class="n">initial_location</span><span class="p">,</span>
        <span class="s2">"rotation"</span><span class="p">:</span> <span class="n">initial_rotation</span><span class="p">,</span>
        <span class="s2">"dynamics"</span><span class="p">:</span>
            <span class="p">{</span>
                <span class="s2">"mass"</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
                <span class="s2">"length"</span><span class="p">:</span> <span class="mf">1.6</span><span class="p">,</span>
                <span class="s2">"rho"</span><span class="p">:</span> <span class="mi">1026</span><span class="p">,</span>
                <span class="s2">"diam"</span><span class="p">:</span> <span class="mf">0.19</span><span class="p">,</span>
                <span class="s2">"r_bg"</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">],</span>
                <span class="s2">"r_bb"</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="s2">"r44"</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
                <span class="s2">"Cd"</span><span class="p">:</span> <span class="mf">0.42</span><span class="p">,</span>
                <span class="s2">"T_surge"</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                <span class="s2">"T_sway"</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                <span class="s2">"zeta_roll"</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
                <span class="s2">"zeta_pitch"</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
                <span class="s2">"T_yaw"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">"K_nomoto"</span><span class="p">:</span> <span class="mf">5.0</span> <span class="o">/</span> <span class="mf">20.0</span>
            <span class="p">},</span>
        <span class="s2">"actuator"</span><span class="p">:</span>
            <span class="p">{</span>
                <span class="s2">"fin_area"</span><span class="p">:</span> <span class="mf">0.00665</span><span class="p">,</span>
                <span class="s2">"deltaMax_fin_deg"</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
                <span class="s2">"nMax"</span><span class="p">:</span> <span class="mi">1525</span><span class="p">,</span>
                <span class="s2">"T_delta"</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="s2">"T_n"</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="s2">"CL_delta_r"</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="s2">"CL_delta_s"</span><span class="p">:</span> <span class="mf">0.7</span>
            <span class="p">},</span>
        <span class="s2">"autopilot"</span><span class="p">:</span>
            <span class="p">{</span>
                <span class="s1">'depth'</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">'wn_d_z'</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
                    <span class="s1">'Kp_z'</span><span class="p">:</span> <span class="mf">0.08</span><span class="p">,</span>
                    <span class="s1">'T_z'</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                    <span class="s1">'Kp_theta'</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>
                    <span class="s1">'Kd_theta'</span><span class="p">:</span> <span class="mf">2.3</span><span class="p">,</span>
                    <span class="s1">'Ki_theta'</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
                    <span class="s1">'K_w'</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s1">'heading'</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">'wn_d'</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span>
                    <span class="s1">'zeta_d'</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
                    <span class="s1">'r_max'</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
                    <span class="s1">'lam'</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                    <span class="s1">'phi_b'</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                    <span class="s1">'K_d'</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                    <span class="s1">'K_sigma'</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">},</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Simulation setup proceeds first by setting up an environment. We pass the vehicle parameters defined in the scenario configuration to a Fossen vehicle object,
which specifies a target HoloOcean agent (e.g., <cite>‘auv0’</cite>). Next we create a dynamics manager, passing the vehicle and simulation time period (1/ticks_per_sec),
to attach the parameters to the agent. Finally we initialize a NumPy array with a length of 6 for accelerations in x, y, z (global frame) and angular
accelerations around the x, y, and z axes (global frame).</p>
<p>In this example we select the <cite>fourFinDep</cite> vehicle, which has 3 control inputs (Rudder Fins, Stern Fins, Thruster).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">holoocean</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">scenario_cfg</span><span class="o">=</span><span class="n">scenario</span><span class="p">)</span>
<span class="n">vehicle</span> <span class="o">=</span> <span class="n">fourFinDep</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="s1">'auv0'</span><span class="p">,</span><span class="s1">'manualControl'</span><span class="p">)</span>
<span class="n">torpedo_dynamics</span> <span class="o">=</span> <span class="n">FossenDynamics</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="n">accel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>  <span class="c1"># HoloOcean parameter input</span>
</pre></div>
</div>
</section>
<section id="manual-control-example">
<h2>Manual Control Example:<a class="headerlink" href="#manual-control-example" title="Permalink to this heading"></a></h2>
<p>To use the manual control method, set the vehicle object to “manualControl” mode.</p>
<p>The fin angles can be passed directly to the vehicle dynamics, and an acceleration array will be returned to the HoloOcean agent given the state of the agent in the HoloOcean world.</p>
<p>The length of the <cite>u_control</cite> array is defined in the dynamic model class. It represents the number of command inputs.</p>
<ul class="simple">
<li><p>Fin angles should be given in radians. The example below shows how to convert fin angles from degrees to radians using NumPy.</p></li>
<li><p>A positive fin deflection of a rudder fin will result in a yaw moment to the starboard side.</p></li>
<li><p>A positive fin deflection of a stern/elevator fin will result in a pitch moment to pitch the vehicle up.</p></li>
</ul>
<p>A custom controller can be used with this manual control method to input specific fin commands.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">vehicle</span><span class="o">.</span><span class="n">set_control_mode</span><span class="p">(</span><span class="s1">'manualControl'</span><span class="p">)</span>
<span class="n">fins_degrees</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">])</span>  <span class="c1"># Rudder and Stern Fin Deflection (degrees)</span>
<span class="n">fin_radians</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">fins_degrees</span><span class="p">)</span>
<span class="n">thruster_rpm</span> <span class="o">=</span> <span class="mi">800</span>
<span class="n">u_control</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fin_radians</span><span class="p">,</span> <span class="n">thruster_rpm</span><span class="p">)</span>  <span class="c1"># [RudderAngle, SternAngle, Thruster]</span>
</pre></div>
</div>
<p>To tick the environment, call the <cite>step</cite> function and pass it a list of accelerations.</p>
<p>We send a command to the control surfaces with the <cite>set_u_control_rad</cite> function on the FossenDynamics object.</p>
<p>It is not required to set the <cite>u_control</cite> every tick. If you want to change the control surfaces every tick, then you should set the control command before updating the dynamics.</p>
<p>The <cite>FossenDynamics.update</cite> function takes in the state returned from HoloOcean and parses the data from the Dynamics Sensor. Given the state of the vehicle and control surface inputs, it calculates an output of accelerations in the HoloOcean frame (NWU).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numSteps</span><span class="p">):</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">accel</span><span class="p">)</span>
    <span class="n">torpedo_dynamics</span><span class="o">.</span><span class="n">set_u_control_rad</span><span class="p">(</span><span class="n">u_control</span><span class="p">)</span>  <span class="c1"># If desired, you can change the control command here</span>
    <span class="n">accel</span> <span class="o">=</span> <span class="n">torpedo_dynamics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>  <span class="c1"># Calculate accelerations to be applied to HoloOcean agent</span>

    <span class="c1"># For Plotting the state of the vehicle</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">'DynamicsSensor'</span><span class="p">][</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>  <span class="c1"># [x, y, z]</span>
    <span class="n">pos_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="n">time_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">'t'</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="depth-and-heading-control-example">
<h2>Depth and Heading Control Example:<a class="headerlink" href="#depth-and-heading-control-example" title="Permalink to this heading"></a></h2>
<p>Depth is defined as negative Z and increases the deeper the vehicle is underwater. Units are in meters.</p>
<p>Heading command ranges from</p>
<blockquote>
<div><p>-180 to 180 in degrees, with 0 deg being north (along the x-axis) and 90 deg East (along the negative y axis). This makes <cite>heading = -yaw</cite> for yaw values in NWU coordinate systems.</p>
</div></blockquote>
<p>The final value 1525 is the actual command value for the thruster in rpm.</p>
<p>Surge control of the vehicle is also supported when specified. This is not enabled by default.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Every time the set_control_mode is called the controller integral values and Low Pass filter is reset. So
this should only be called when switching control modes and should not be placed in the for loop.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">depth</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">heading</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">vehicle</span><span class="o">.</span><span class="n">set_goal</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span><span class="n">heading</span><span class="p">,</span><span class="mi">1525</span><span class="p">)</span>     <span class="c1">#Changes depth (positive depth), heading, thruster RPM goals for controller</span>
<span class="n">vehicle</span><span class="o">.</span><span class="n">set_control_mode</span><span class="p">(</span><span class="s1">'depthHeadingAutopilot'</span><span class="p">)</span> <span class="c1">#In this mode PID controller calculates control commands (u_control)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numSteps</span><span class="p">):</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">accel</span><span class="p">)</span>
    <span class="n">accel</span> <span class="o">=</span> <span class="n">torpedo_dynamics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

    <span class="c1"># For plotting and arrows</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">'DynamicsSensor'</span><span class="p">][</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>  <span class="c1"># [x, y, z]</span>
    <span class="n">x_end</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">heading</span><span class="p">))</span>
    <span class="n">y_end</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">heading</span><span class="p">))</span>
    <span class="n">pos_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="n">time_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">'t'</span><span class="p">])</span>

    <span class="c1">#change color if within 2 meters</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">depth</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mf">2.0</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">env</span><span class="o">.</span><span class="n">draw_arrow</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="p">[</span><span class="n">x_end</span><span class="p">,</span> <span class="n">y_end</span><span class="p">,</span> <span class="o">-</span><span class="n">depth</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">lifetime</span><span class="o">=</span><span class="mf">0.03</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="plotting-vehicle-state">
<h2>Plotting Vehicle State:<a class="headerlink" href="#plotting-vehicle-state" title="Permalink to this heading"></a></h2>
<p>The following code block is optional to plot the vehicle state</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plot</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="c1"># Convert position list to a numpy array for easier slicing</span>
    <span class="n">pos_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos_list</span><span class="p">)</span>

    <span class="c1"># Extract x, y, and z positions</span>
    <span class="n">x_positions</span> <span class="o">=</span> <span class="n">pos_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="c1">#North Position</span>
    <span class="n">y_positions</span> <span class="o">=</span> <span class="n">pos_array</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1">#West Position</span>
    <span class="n">east_positions</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">y_positions</span><span class="p">]</span> <span class="c1">#Convert from west to east</span>
    <span class="n">z_positions</span> <span class="o">=</span> <span class="n">pos_array</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>   <span class="c1">#Z positions (Z up)</span>

    <span class="c1"># Plot x and y positions</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span> <span class="n">east_positions</span><span class="p">,</span><span class="n">x_positions</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'o'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'X and Y Positions'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'East (meters)'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'North (meters)'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Plot z positions over time</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_list</span><span class="p">,</span> <span class="n">z_positions</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'o'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Z Position over Time'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Time Step'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Z Position'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Show the plots</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
</div>
</div>
<footer><div aria-label="Footer" class="rst-footer-buttons" role="navigation">
<a accesskey="p" class="btn btn-neutral float-left" href="custom-scenarios.html" rel="prev" title="Custom Scenario Configurations"><span aria-hidden="true" class="fa fa-arrow-circle-left"></span> Previous</a>
<a accesskey="n" class="btn btn-neutral float-right" href="multi-agent.html" rel="next" title="Multi Agent Example">Next <span aria-hidden="true" class="fa fa-arrow-circle-right"></span></a>
</div>
<hr/>
<div role="contentinfo">
<p>© Copyright BYU FRoStLab.</p>
</div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
</div>
</div>
</section>
</div>
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
</body>
</html>